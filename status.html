<!-- Layout for 4 chart -->
<div style='height:54px;'></div>
<div class="row">
  <div style='width:54px;'></div>
  <div class="card-deck">

    <!-- 1st floor -->
    <div class="card card-inverse text-white mb-3 text-center" style="background-color: #333333; border-color: #333333;">
      <div class="card-body" id="area1">
        <div style='height:20px;'></div>
        <h4>1st Floor</h4>
        <div style='height:20px;'></div>
      </div>
      <div class="card-footer">
        <small class="text-muted" id="footer1">Retreiving data...</small>
      </div>
    </div>

    <!-- 2nd floor -->
    <div class="card card-inverse text-white mb-3 text-center" style="background-color: #333333; border-color: #333333;">
      <div class="card-body" id="area2">
        <div style='height:20px;'></div>
        <h4>2nd Floor</h4>
        <div style='height:20px;'></div>
      </div>
      <div class="card-footer">
        <small class="text-muted" id="footer2">Retreiving data...</small>
      </div>
    </div>

    <!-- 3rd floor -->
    <div class="card card-inverse text-white mb-3 text-center" style="background-color: #333333; border-color: #333333;">
      <div class="card-body" id="area3">
        <div style='height:20px;'></div>
        <h4>3rd Floor</h4>
        <div style='height:20px;'></div>
      </div>
      <div class="card-footer">
        <small class="text-muted" id="footer3">Retreiving data...</small>
      </div>
    </div>
   
    <!-- 4th floor -->
    <div class="card card-inverse text-white mb-3 text-center" style="background-color: #333333; border-color: #333333;">
      <div class="card-body" id="area4">
        <div style='height:20px;'></div>
        <h4>4th Floor</h4>
        <div style='height:20px;'></div>
      </div>
      <div class="card-footer">
        <small class="text-muted" id="footer4">Retreiving data...</small>
      </div>
    </div>

  </div>
</div>


<style>
  .arc text {
    font: 10px sans-serif;
    text-anchor: middle;
  }

  .arc path {
    stroke: #fff;
  }
</style>


<script>
/* Var setup */
var x = 0;
var gArr = [];
var maxChart = 4;
var maxBlock = 200;

var initDataset = [
  { name: 'bike', total: 0 },
  { name: 'empty', total: 200  }
];

/* Set up */
var width = 240,
    textSize = "1em",
    height = 125,
    radius = Math.min(width, height) / 2;

/* Color for chart, first data use first color and so on */
var color = d3.scale.ordinal()
    .range(["#ff4d4d", "#ffe6e6", "#7b6888", "#6b486b", "#a05d56"]); 

var arc = d3.svg.arc()
                .outerRadius(radius - height/25)
                .innerRadius(radius - height/25*7);

var pie = d3.layout.pie()
                    .sort(null)
                    .startAngle(1.1*Math.PI)
                    .endAngle(3.1*Math.PI)
                    .value(function(d) { return d.total; });

/* Add element */
var chart1 = d3.select("#area1").append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

gArr[0] = chart1.selectAll(".arc")
              .data(pie(initDataset))
              .enter().append("g")
              .attr("class", "arc"); /* setting all of g in chart1 to class arc */

/* Add element */
var chart2 = d3.select("#area2").append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

gArr[1] = chart2.selectAll(".arc")
              .data(pie(initDataset))
              .enter().append("g")
              .attr("class", "arc"); /* setting all of g in chart1 to class arc */
  
/* Add element */
var chart3 = d3.select("#area3").append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

gArr[2] = chart3.selectAll(".arc")
              .data(pie(initDataset))
              .enter().append("g")
              .attr("class", "arc"); /* setting all of g in chart1 to class arc */
  
/* Add element */
var chart4 = d3.select("#area4").append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

gArr[3] = chart4.selectAll(".arc")
              .data(pie(initDataset))
              .enter().append("g")
              .attr("class", "arc"); /* setting all of g in chart1 to class arc */

SetUpChart(gArr[0]);
SetUpChart(gArr[1]);
SetUpChart(gArr[2]);
SetUpChart(gArr[3]);

console.log(gArr);

function SetUpChart(tar)
{
  /* Color of chart for different data */
  tar.append("path") // every g has a path
   .style("fill", function(d) { return color(d.data.name); })
   .transition().delay(function(d,i) {return i * 500; })
   .duration(1500)
   .attrTween('d', function(d) 
     {
       var i = d3.interpolate(d.startAngle+0.1, d.endAngle);
       return function(t) 
       {
          d.endAngle = i(t); 
          return arc(d)
       }
    })
   .each(function(d) { this._current = d;}); // store the initial angles 

  tar.append("text")
       .attr("text-anchor", "middle")
       .style("font-size", textSize)
       .style("fill", "white")
       .attr('y', height/20)
       .text(maxBlock);
}
  
function type(d) {
  d.total = +d.total;
  return d;
}

</script>



<script>
/* Update footer time */
function DateDiff(date1, date2)
{
  var diff = {s:0, m:0, h:0, d:0};
  var diffMs = (date1 - date2); // milliseconds between now & Christmas
  diff.d = Math.floor(diffMs / 86400000); // days
  diff.h = Math.floor((diffMs % 86400000) / 3600000); // hours
  diff.m = Math.round(((diffMs % 86400000) % 3600000) / 60000); // minutes
  diff.s = Math.round(((diffMs % 86400000) % 3600000) % 60000 / 1000 ); // second
  return diff;
}
function UpdateDiffTime()
{
  for(var i=0; i<maxChart; i++)
  {
    diff = DateDiff(new Date(), dateTime[i]);
    if(diff.m <= 0)
      document.getElementById("footer"+(i+1).toString()).innerHTML = "Updated " + diff.s + " sec ago...";
    else
      document.getElementById("footer"+(i+1).toString()).innerHTML = "Updated " + diff.m + " min ago...";
  }
}
</script>

<script>
var urls = ["https://api.mediatek.com/mcs/v2/devices/D50Vc0GM/datachannels/Test_only/datapoints",
            "https://api.mediatek.com/mcs/v2/devices/D50Vc0GM/datachannels/Test_only/datapoints",
            "https://api.mediatek.com/mcs/v2/devices/D50Vc0GM/datachannels/Test_only/datapoints",
           "https://api.mediatek.com/mcs/v2/devices/D50Vc0GM/datachannels/Test_only/datapoints"];
var devKey = ["jur0mgrSH4gJ8KJr",
              "jur0mgrSH4gJ8KJr",
              "jur0mgrSH4gJ8KJr",
              "jur0mgrSH4gJ8KJr"];
var dateTime = [];
/* AJAX set up */
var cnt = [0,0,0,0];
var inc = [1,2,1,2];
var xhrArr = [];
var CallBack = function(index){
  return function(){
    if(xhrArr[index].readyState == 4 && xhrArr[index].status == 200) 
      {
          var dataPoint = JSON.parse(xhrArr[index].response).dataChannels[0].dataPoints[0].values.value
          console.log(dataPoint);

          /* Update the chart */
          dataPoint += cnt[index];
          cnt[index] += inc[index];
          var newData =  [ { name: 'bike', total: dataPoint }, { name: 'empty', total: maxBlock - dataPoint  }];
          change(newData, gArr[index]);

          /* Record current time for footer update */
          dateTime[index] = new Date();
      }
  }
}

/* Request data for every minute */
RequestMCSData();
setInterval(RequestMCSData, 10000);
setInterval(UpdateDiffTime, 1000);
function RequestMCSData()
{
    for(var i=0; i<maxChart; i++) 
    {
      xhrArr[i]=new XMLHttpRequest();
      xhrArr[i].open("GET", urls[i], true);
      xhrArr[i].setRequestHeader("deviceKey", devKey[i]);
      xhrArr[i].setRequestHeader("Content-Type", "application/json");
      xhrArr[i].onreadystatechange=CallBack(i);
      xhrArr[i].send();
    }
} 

/* Updating chart */
function change(data, tar) {
    /* Update chart, select the path in this g */
    tar.select("path") 
    .data(pie(data))
    .transition().duration(750).attrTween("d", arcTween); // redraw the arcs

    /* Show the number of empty block, with a little delay */
    tar.select("text")
    .transition()
    .delay(500)
    .text(data[1].total) // empty number

}
function arcTween(a) {
    //console.log(this._current); // undefine
    var i = d3.interpolate(this._current, a);
    this._current = i(0);
    return function(t) {
        return arc(i(t));
    };
}
</script>

